name: HTTPS Proxy via Cloudflared

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install Squid Proxy
      run: |
        sudo apt update
        sudo apt install -y squid curl

    - name: Configure Squid
      run: |
        sudo tee /etc/squid/squid.conf > /dev/null <<EOF
        http_port 3128
        acl all src all
        http_access allow all
        access_log stdio:/dev/stdout
        EOF

    - name: Start Squid Proxy
      run: sudo systemctl restart squid

    - name: Install Cloudflared
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/

    - name: Start Cloudflared Tunnel (Squid Port 3128)
      run: |
        nohup cloudflared tunnel --url http://localhost:3128 --no-autoupdate > /tmp/cloudflared.log 2>&1 &

    - name: Wait and Fetch Tunnel URL
      run: |
        sleep 8
        cat /tmp/cloudflared.log | grep -o 'https://[^ ]*trycloudflare.com' || echo "Waiting failed or URL not found"

    - name: Keep alive
      run: tail -f /dev/null
