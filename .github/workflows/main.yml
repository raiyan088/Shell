name: HTTPS Squid Proxy via Cloudflare Tunnel

on: [push, workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y squid openssl wget curl

    - name: Generate Self-Signed SSL Certificate
      run: |
        sudo mkdir -p /etc/squid/certs
        openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
          -keyout squid.key -out squid.crt -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=proxy.raiyan086.xyz"
        sudo mv squid.key /etc/squid/certs/
        sudo mv squid.crt /etc/squid/certs/
        sudo chmod 600 /etc/squid/certs/*

    - name: Configure Squid for HTTPS
      run: |
        sudo tee /etc/squid/squid.conf > /dev/null <<EOF
        https_port 3129 cert=/etc/squid/certs/squid.crt key=/etc/squid/certs/squid.key
        acl all src all
        http_access allow all
        access_log stdio:/dev/stdout
        cache deny all
        EOF

    - name: Restart Squid
      run: |
        sudo systemctl restart squid
        sudo systemctl enable squid

    - name: Download cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/cloudflared

    - name: Setup Cloudflared config
      run: |
        mkdir -p ~/.cloudflared
        tee ~/.cloudflared/config.yml > /dev/null <<EOF
        tunnel: 3f3e7910-868d-4348-b908-0aa8de48d347
        credentials-file: /home/runner/.cloudflared/creds.json
        ingress:
          - hostname: proxy.raiyan086.xyz
            service: https://localhost:3129
            originRequest:
              noTLSVerify: true
          - service: http_status:404
        EOF

    - name: Create Tunnel credentials file
      run: |
        echo 'eyJhIjoiYWM2NDc1NzkyZTJkNjY3ODc4M2JmMTFhOGI5MTFiYzciLCJ0IjoiM2YzZTc5MTAtODY4ZC00MzQ4LWI5MDgtMGFhOGRlNDhkMzQ3IiwicyI6IlltSm1ZMkZsTnpndE5EVXlPQzAwWXpreUxXSXhOMll0TnpNMU9HWXlaakZrTkRjeiJ9' > ~/.cloudflared/creds.json

    - name: Start Cloudflared Tunnel
      run: |
        cloudflared tunnel run 3f3e7910-868d-4348-b908-0aa8de48d347 &

    - name: Wait & Test Proxy with curl
      run: |
        sleep 10
        curl -x https://proxy.raiyan086.xyz https://ipinfo.io --proxy-insecure

    - name: Keep Alive
      run: tail -f /dev/null
