name: HTTPS Squid Proxy via Cloudflare Tunnel

on: [push, workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Dante and Ngrok
        run: |
          sudo apt update
          sudo apt install -y dante-server curl jq
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc
          echo "deb https://ngrok.com/download ngrok stable" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      - name: Setup Dante Proxy Server
        run: |
          sudo bash -c 'echo "
          logoutput: /var/log/danted.log
          internal: eth0 port = 1080
          external: eth0
          method: username none
          user.privileged: root
          user.unprivileged: nobody
          clientmethod: none
          socksmethod: username none
          " > /etc/danted.conf'

          sudo systemctl start danted

      - name: Setup and Run Ngrok Tunnel
        run: |
          ngrok authtoken 2YMpPG6ws3Y1x5unwwSlUNVs3Wu_67JPAFd2MmxAo7cBVK7Lq
          nohup ngrok tcp 1080 > ngrok.log &
          sleep 10
          curl --silent http://localhost:4040/api/tunnels > tunnels.json
          cat tunnels.json | jq

      - name: Keep Running
        run: |
          echo "Dante SOCKS5 Proxy is running on Ngrok TCP tunnel..."
          tail -f /dev/null
