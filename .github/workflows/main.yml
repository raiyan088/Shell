name: HTTP Squid Proxy via Cloudflare Tunnel

on: [push, workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y squid wget curl

    - name: Configure Squid for HTTP
      run: |
        sudo tee /etc/squid/squid.conf > /dev/null <<EOF
        http_port 3128
        acl localnet src all
        http_access allow localnet
        access_log stdio:/dev/stdout
        cache deny all
        EOF

    - name: Restart Squid
      run: |
        sudo systemctl stop squid || true
        sudo rm -f /run/squid.pid
        sudo squid -z
        sudo systemctl start squid
        sudo systemctl enable squid

    - name: Download cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/cloudflared

    - name: Setup Cloudflared config
      run: |
        mkdir -p ~/.cloudflared
        tee ~/.cloudflared/config.yml > /dev/null <<EOF
        tunnel: 3f3e7910-868d-4348-b908-0aa8de48d347
        credentials-file: /home/runner/.cloudflared/creds.json
        ingress:
          - hostname: proxy.raiyan086.xyz
            service: http://localhost:3128
          - service: http_status:404
        EOF

    - name: Create Tunnel credentials file
      run: |
        echo 'eyJhIjoiYWM2NDc1NzkyZTJkNjY3ODc4M2JmMTFhOGI5MTFiYzciLCJ0IjoiM2YzZTc5MTAtODY4ZC00MzQ4LWI5MDgtMGFhOGRlNDhkMzQ3IiwicyI6IlltSm1ZMkZsTnpndE5EVXlPQzAwWXpreUxXSXhOMll0TnpNMU9HWXlaakZrTkRjeiJ9' > ~/.cloudflared/creds.json

    - name: Start Cloudflared Tunnel
      run: |
        cloudflared tunnel run 3f3e7910-868d-4348-b908-0aa8de48d347 &

    - name: Wait & Test Proxy with curl
      run: |
        sleep 10
        curl -x http://proxy.raiyan086.xyz http://ipinfo.io

    - name: Keep Alive
      run: tail -f /dev/null
